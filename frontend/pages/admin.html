<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - ICST University</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .crud-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .crud-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .crud-tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .crud-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .crud-content {
            display: none;
        }
        
        .crud-content.active {
            display: block;
        }
        
        .crud-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 1rem;
            top: 1rem;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .btn-edit {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-edit:hover {
            background-color: #e0a800;
        }
        
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #c82333;
        }
        .stats-grid {
    display: flex;
    gap: 1rem;
    margin: 2rem 0;
    justify-content: center;
    flex-wrap: wrap;
}
.stat-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    padding: 1.2rem 2rem;
    min-width: 180px;
    transition: box-shadow 0.2s;
}
.stat-card:hover {
    box-shadow: 0 4px 16px rgba(80,120,200,0.13);
}
.stat-icon {
    font-size: 2.5rem;
    color: #2563eb;
    margin-bottom: 0.5rem;
}
.stat-card h4 {
    margin: 0;
    font-size: 1.1rem;
    color: #222e3a;
}
.stat-card span {
    margin-top: 0.3rem;
    font-size: 1.5rem;
    font-weight: bold;
    color: #2563eb;
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ICST University</h1>
            <h2>Admin Panel</h2>
        </header>

        <nav>
            <ul>
                <!-- Navigation will be populated by auth.js based on user role -->
            </ul>
        </nav>

        <main>
            <div class="admin-dashboard">
                <h3>System Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fa-solid fa-users stat-icon"></i>
                        <h4>Total Students</h4>
                        <span id="totalStudents">Loading...</span>
                    </div>
                    <div class="stat-card">
                        <i class="fa-solid fa-book stat-icon"></i>
                        <h4>Total Courses</h4>
                        <span id="totalCourses">Loading...</span>
                    </div>
                    <div class="stat-card">
                        <i class="fa-solid fa-clipboard-list stat-icon"></i>
                        <h4>Active Registrations</h4>
                        <span id="totalRegistrations">Loading...</span>
                    </div>
                    <div class="stat-card">
                        <i class="fa-solid fa-building-columns stat-icon"></i>
                        <h4>Departments</h4>
                        <span id="totalDepartments">Loading...</span>
                    </div>
                </div>
            </div>

            <div class="crud-section">
                <h3>Manage System Data</h3>
                <div class="crud-tabs">
                    <button class="crud-tab active" data-tab="students">Students</button>
                    <button class="crud-tab" data-tab="courses">Courses</button>
                    <button class="crud-tab" data-tab="departments">Departments</button>
                </div>

                <!-- Students Management -->
                <div class="crud-content active" id="students-content">
                    <div class="crud-actions">
                        <button class="btn btn-primary" onclick="openAddModal('student')">Add Student</button>
                        <button class="btn btn-secondary" onclick="loadStudents()">Refresh</button>
                    </div>
                    <div id="studentsTable"></div>
                </div>

                <!-- Courses Management -->
                <div class="crud-content" id="courses-content">
                    <div class="crud-actions">
                        <button class="btn btn-primary" onclick="openAddModal('course')">Add Course</button>
                        <button class="btn btn-secondary" onclick="loadCourses()">Refresh</button>
                    </div>
                    <div id="coursesTable"></div>
                </div>

                <!-- Departments Management -->
                <div class="crud-content" id="departments-content">
                    <div class="crud-actions">
                        <button class="btn btn-primary" onclick="openAddModal('department')">Add Department</button>
                        <button class="btn btn-secondary" onclick="loadDepartments()">Refresh</button>
                    </div>
                    <div id="departmentsTable"></div>
                </div>
            </div>

            <div class="course-demand">
                <h3>Course Demand Analysis</h3>
                <div id="courseDemandContainer">
                    <!-- Course demand data will be loaded here -->
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 Click 2 Entroll Project Team. All rights reserved..</p>
        </footer>
    </div>

    <!-- CRUD Modal -->
    <div id="crudModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCrudModal()">&times;</span>
            <h3 id="modalTitle">Add Item</h3>
            <form id="crudForm">
                <div id="formFields"></div>
                <div style="margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p id="modalMessage"></p>
        </div>
    </div>

    <script src="../js/app.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentEntity = 'students';
        let editingId = null;
        let departments = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication and require admin role
            if (!auth.requireRole('admin')) {
                return;
            }
            
            loadAdminDashboard();
            loadDepartments();
            loadStudents();
            loadCourseDemand();
            
            // Tab functionality
            document.querySelectorAll('.crud-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
            
            // Form submission
            document.getElementById('crudForm').addEventListener('submit', handleFormSubmit);
        });

        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.crud-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update active content
            document.querySelectorAll('.crud-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-content`).classList.add('active');
            
            currentEntity = tabName;
            
            // Load data for the selected tab
            switch(tabName) {
                case 'students':
                    loadStudents();
                    break;
                case 'courses':
                    loadCourses();
                    break;
                case 'departments':
                    loadDepartments();
                    break;
            }
        }

        async function loadAdminDashboard() {
            try {
                // Load students count
                const studentsResponse = await fetch('../../backend/controllers/fetch_students.php');
                const studentsData = await studentsResponse.json();
                if (studentsData.success) {
                    document.getElementById('totalStudents').textContent = studentsData.data.length;
                }

                // Load courses count
                const coursesResponse = await fetch('../../backend/controllers/fetch_courses.php');
                const coursesData = await coursesResponse.json();
                if (coursesData.success) {
                    document.getElementById('totalCourses').textContent = coursesData.data.length;
                }

                // Load departments count
                const departmentsResponse = await fetch('../../backend/controllers/fetch_departments.php');
                const departmentsData = await departmentsResponse.json();
                if (departmentsData.success) {
                    document.getElementById('totalDepartments').textContent = departmentsData.data.length;
                }

                // Load registrations count
                const enrollmentsResponse = await fetch('../../backend/controllers/fetch_enrollments.php');
                const enrollmentsData = await enrollmentsResponse.json();
                if (enrollmentsData.success) {
                    document.getElementById('totalRegistrations').textContent = enrollmentsData.data.length;
                }
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
            }
        }

        async function loadStudents() {
            try {
                const response = await fetch('../../backend/controllers/fetch_students.php');
                const data = await response.json();
                
                if (data.success) {
                    displayStudentsTable(data.data);
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        async function loadCourses() {
            try {
                const response = await fetch('../../backend/controllers/fetch_courses.php');
                const data = await response.json();
                
                if (data.success) {
                    displayCoursesTable(data.data);
                }
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        async function loadDepartments() {
            try {
                const response = await fetch('../../backend/controllers/fetch_departments.php');
                const data = await response.json();
                
                if (data.success) {
                    departments = data.data;
                    displayDepartmentsTable(data.data);
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        function displayStudentsTable(students) {
            const container = document.getElementById('studentsTable');
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            students.forEach(student => {
                tableHTML += `
                    <tr>
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td>${student.email}</td>
                        <td>${student.department_name}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit btn-small" onclick="editStudent(${student.id})">Edit</button>
                                <button class="btn btn-delete btn-small" onclick="deleteStudent(${student.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function displayCoursesTable(courses) {
            const container = document.getElementById('coursesTable');
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Course Code</th>
                            <th>Name</th>
                            <th>Department</th>
                            <th>Seat Limit</th>
                            <th>Enrolled</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            courses.forEach(course => {
                tableHTML += `
                    <tr>
                        <td>${course.id}</td>
                        <td>${course.course_code}</td>
                        <td>${course.name}</td>
                        <td>${course.department_name}</td>
                        <td>${course.seat_limit}</td>
                        <td>${course.enrolled_count}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit btn-small" onclick="editCourse(${course.id})">Edit</button>
                                <button class="btn btn-delete btn-small" onclick="deleteCourse(${course.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function displayDepartmentsTable(departments) {
            const container = document.getElementById('departmentsTable');
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            departments.forEach(department => {
                tableHTML += `
                    <tr>
                        <td>${department.id}</td>
                        <td>${department.name}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit btn-small" onclick="editDepartment(${department.id})">Edit</button>
                                <button class="btn btn-delete btn-small" onclick="deleteDepartment(${department.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function openAddModal(entity, data = null, id = null) {
    editingId = id;
    const modal = document.getElementById('crudModal');
    const title = document.getElementById('modalTitle');
    const formFields = document.getElementById('formFields');

    const isEdit = !!data;
    title.textContent = isEdit ? `Edit ${entity}` : `Add ${entity.charAt(0).toUpperCase() + entity.slice(1)}`;

    let fieldsHTML = '';

    switch(entity) {
        case 'student':
            fieldsHTML = `
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required value="${data?.name || ''}">
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required value="${data?.email || ''}">
                </div>
                <div class="form-group">
                    <label for="department_id">Department:</label>
                    <select id="department_id" name="department_id" required>
                        <option value="">Select Department</option>
                        ${departments.map(dept => 
                            `<option value="${dept.id}" ${dept.id == data?.department_id ? 'selected' : ''}>${dept.name}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" placeholder="Leave blank for default (student123)">
                </div>
            `;
            break;
        case 'course':
            fieldsHTML = `
                <div class="form-group">
                    <label for="name">Course Name:</label>
                    <input type="text" id="name" name="name" required value="${data?.name || ''}">
                </div>
                <div class="form-group">
                    <label for="course_code">Course Code:</label>
                    <input type="text" id="course_code" name="course_code" required value="${data?.course_code || ''}">
                </div>
                <div class="form-group">
                    <label for="department_id">Department:</label>
                    <select id="department_id" name="department_id" required>
                        <option value="">Select Department</option>
                        ${departments.map(dept => 
                            `<option value="${dept.id}" ${dept.id == data?.department_id ? 'selected' : ''}>${dept.name}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="seat_limit">Seat Limit:</label>
                    <input type="number" id="seat_limit" name="seat_limit" min="1" value="${data?.seat_limit || 30}" required>
                </div>
            `;
            break;

                    case 'department':
                        fieldsHTML = `
                            <div class="form-group">
                                <label for="name">Department Name:</label>
                                <input type="text" id="name" name="name" required value="${data?.name || ''}">
                            </div>
                        `;
                        break;
                }


    formFields.innerHTML = fieldsHTML;
    modal.style.display = 'block';
}


async function editStudent(id) {
    try {
        const response = await fetch('../../backend/controllers/fetch_students.php');
        const data = await response.json();

        if (data.success) {
            const student = data.data.find(s => s.id == id);
            if (student) {
                openAddModal('student', student, id); // Pass full data + id
            }
        }
    } catch (error) {
        showMessage('Error loading student data: ' + error.message, 'error');
    }
}


async function editCourse(id) {
    try {
        const response = await fetch('../../backend/controllers/fetch_courses.php');
        const data = await response.json();

        if (data.success) {
            const course = data.data.find(c => c.id == id);
            if (course) {
                openAddModal('course', {
                    id: course.id,
                    name: course.name,
                    course_code: course.course_code,
                    department_id: course.department_id,
                    seat_limit: course.seat_limit
                }, id);
            }
        }
    } catch (error) {
        showMessage('Error loading course data: ' + error.message, 'error');
    }
}


function editDepartment(id) {
    const department = departments.find(d => d.id == id);
    if (department) {
        openAddModal('department', {
            id: department.id,
            name: department.name
        }, id);
    }
}


        async function deleteStudent(id) {
            if (!confirm('Are you sure you want to delete this student? This will also remove all their course registrations.')) {
                return;
            }
            
            try {
                const response = await fetch(`../../backend/controllers/admin_crud.php?entity=students&action=delete&id=${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    loadStudents();
                    loadAdminDashboard();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Error deleting student: ' + error.message, 'error');
            }
        }

        async function deleteCourse(id) {
            if (!confirm('Are you sure you want to delete this course? This will also remove all registrations for this course.')) {
                return;
            }
            
            try {
                const response = await fetch(`../../backend/controllers/admin_crud.php?entity=courses&action=delete&id=${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    loadCourses();
                    loadAdminDashboard();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Error deleting course: ' + error.message, 'error');
            }
        }

        async function deleteDepartment(id) {
            if (!confirm('Are you sure you want to delete this department? This will also delete all students and courses in this department.')) {
                return;
            }
            
            try {
                const response = await fetch(`../../backend/controllers/admin_crud.php?entity=departments&action=delete&id=${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    loadDepartments();
                    loadAdminDashboard();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Error deleting department: ' + error.message, 'error');
            }
        }

        
async function handleFormSubmit(e) {
    console.log("ðŸš€ handleFormSubmit triggered");
    console.log("Current entity:", currentEntity);
    console.log("Editing ID:", editingId);

            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Remove empty password field for students
            if (currentEntity === 'students' && !data.password) {
                delete data.password;
            }
            
            const isEdit = editingId !== null;
            const action = isEdit ? 'update' : 'create';
            const method = 'POST'; // Always POST

            if (isEdit) {
                data.id = editingId;
                data._method = 'PUT';
            }
            
            try {
                
console.log("ðŸ”„ Submitting data:", data);
console.log("ðŸ”— Request URL:", `../../backend/controllers/admin_crud.php?entity=${currentEntity}&action=${action}`);
const response = await fetch(`../../backend/controllers/admin_crud.php?entity=${currentEntity}&action=${action}`, {

                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeCrudModal();
                    
                    // Reload the appropriate data
                    switch(currentEntity) {
                        case 'students':
                            loadStudents();
                            break;
                        case 'courses':
                            loadCourses();
                            break;
                        case 'departments':
                            loadDepartments();
                            break;
                    }
                    
                    loadAdminDashboard();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Error saving data: ' + error.message, 'error');
            }
        }

        
function closeCrudModal() {
    console.log("âŒ Closing modal and resetting form.");
    editingId = null;

            document.getElementById('crudModal').style.display = 'none';
            document.getElementById('crudForm').reset();
            editingId = null;
        }

        async function loadCourseDemand() {
            try {
                const response = await fetch('../../backend/controllers/fetch_courses.php');
                const data = await response.json();
                
                if (data.success) {
                    displayCourseDemand(data.data);
                }
            } catch (error) {
                console.error('Error loading course demand:', error);
            }
        }

        function displayCourseDemand(courses) {
            const container = document.getElementById('courseDemandContainer');
            
            // Sort courses by enrollment percentage (demand)
            const sortedCourses = courses.sort((a, b) => {
                const demandA = (a.enrolled_count / a.seat_limit) * 100;
                const demandB = (b.enrolled_count / b.seat_limit) * 100;
                return demandB - demandA;
            });
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Course</th>
                            <th>Department</th>
                            <th>Enrolled</th>
                            <th>Capacity</th>
                            <th>Demand %</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedCourses.forEach(course => {
                const demandPercent = ((course.enrolled_count / course.seat_limit) * 100).toFixed(1);
                let statusClass = 'status-low';
                let status = 'Low Demand';
                
                if (demandPercent >= 90) {
                    statusClass = 'status-full';
                    status = 'High Demand';
                } else if (demandPercent >= 70) {
                    statusClass = 'status-medium';
                    status = 'Medium Demand';
                }
                
                tableHTML += `
                    <tr>
                        <td>${course.course_code} - ${course.name}</td>
                        <td>${course.department_name}</td>
                        <td>${course.enrolled_count}</td>
                        <td>${course.seat_limit}</td>
                        <td>${demandPercent}%</td>
                        <td><span class="${statusClass}">${status}</span></td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('crudModal');
            if (event.target === modal) {
                closeCrudModal();
            }
        }
    </script>
</body>
</html>
